{% extends "allenatore/template.html.twig" %}
{% block head %}
    <link rel="stylesheet" href="{{ asset('css/chat2.css') }}"/>
{% endblock %}

{% block contenuto %}
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <span class="glyphicon glyphicon-comment"></span> Chat
                    </div>
                    <div class="panel-body">
                        <ul class="chat">
                            {% for messaggio in messaggi %}
                                {% if messaggio.getMittente() == "allenatore" %}
                                    <li class="right clearfix">
                                        <span class="chat-img pull-right">
                                            <img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar"
                                                 class="img-circle"/>
                                        </span>
                                        <div class="chat-body clearfix">
                                            <div class="header">
                                                <small class=" text-muted">
                                                    <span class="glyphicon glyphicon-time"></span>
                                                    {{ messaggio.getData() }}
                                                </small>
                                                <strong class="pull-right primary-font">{{ messaggio.getNomeMittente() }}
                                                    &nbsp;{{ messaggio.getCognomeMittente() }}</strong>
                                            </div>
                                            <p>
                                                {{ messaggio.getTesto() }}
                                            </p>
                                        </div>
                                    </li>

                                {% elseif messaggio.getMittente() == "calciatore" %}
                                    <li class="left clearfix">
                                        <span class="chat-img pull-left">
                                            <img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar"
                                                 class="img-circle"/>
                                        </span>
                                        <div class="chat-body clearfix">
                                            <div class="header">
                                                <strong class="primary-font">{{ messaggio.getNomeMittente() }}
                                                    &nbsp;{{ messaggio.getCognomeMittente() }}</strong>
                                                <small class="pull-right text-muted">
                                                    <span class="glyphicon glyphicon-time"></span>{{ messaggio.getData() }}
                                                </small>
                                            </div>
                                            <p>
                                                {{ messaggio.getTesto() }}
                                            </p>
                                        </div>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <!--<input id="message_target" type="hidden" value="{{ destinatario }}" name="destinatario">-->
                            <input id="chatInput" name="testo" type="text"
                                   placeholder="Scrivi un messaggio..."
                                   class="form-control chat-input">
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="send">Invio</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script
            src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>

    <script>
        var lastTimeID = 0;

        $(document).ready(function () {
            $('#send').click(function () {
                sendChatText();
                $('#chatInput').val("");
            });
            startChat();
        });

        function startChat() {
            setInterval(function () {
                //getChatText();
            }, 2000);
        }

        function getChatText() {
            $.ajax({
                type: "GET",
                url: "/refresh.php?lastTimeID=" + lastTimeID
            }).done(function (data) {
                var jsonData = JSON.parse(data);
                var jsonLength = jsonData.results.length;
                var html = "";
                for (var i = 0; i < jsonLength; i++) {
                    var result = jsonData.results[i];
                    html += '<div style="color:#' + result.color + '">(' + result.chattime + ') <b>' + result.usrname + '</b>: ' + result.chattext + '</div>';
                    lastTimeID = result.id;
                }
                $('#view_ajax').append(html);
            });
        }

        function sendChatText() {
            var chatInput = $('#chatInput').val();
            if (chatInput != "") {
                $.ajax({
                    url: "{{ path('allenatoreInviaMessaggioChat') }}",
                    type: "POST",
                    dataType: 'json',
                    data: {
                        "destinatario": "{{ destinatario }}",
                        "testo": $("#chatInput").val()
                    },
                    cache: false,
                    success: function (data, textStatus, jqXHR) {
                        alert("nomeMittente: " + data.nomeMittente);
                        alert("cognomeMittente: " + data.cognomeMittente);
                        alert("testo: " + data.testo);
                        alert("data: " + data.data);
                        alert("mittente: " + data.mittente);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {

                    }
                });
            }
        }
    </script>
{% endblock %}